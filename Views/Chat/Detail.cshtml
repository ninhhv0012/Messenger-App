@model List<Messenger_App.Models.MessageDTO>
@{
    var chatId = ViewData["ChatId"];
    var currentUserId = (int)ViewData["CurrentUserId"];
    var currentUsername = ViewData["CurrentUsername"]?.ToString() ?? "Người dùng";
    var chatType = ViewData["ChatType"]?.ToString() ?? "Personal";
    var chatName = ViewData["ChatName"]?.ToString() ?? "Chat";
    ViewData["Title"] = chatName;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">@chatName</h4>
    <span id="connection-status" class="badge bg-secondary">Đang kết nối...</span>
</div>

<input type="hidden" id="chatId" value="@chatId" />
<input type="hidden" id="currentUserId" value="@currentUserId" />
<input type="hidden" id="currentUsername" value="@currentUsername" />
<input type="hidden" id="chatType" value="@chatType" />

<div id="detailContainer" style="height:400px;overflow:auto;">
    <!-- Thêm indicator loading tin nhắn -->
    <div id="loadingMessages" class="text-center p-2" style="display:none;">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
        <span class="ms-2">Đang tải tin nhắn cũ...</span>
    </div>
    <div id="messageList">
        @if (!Model.Any())
        {
            <p class="text-muted">Chưa có tin nhắn</p>
        }
        else
        {
            @await Html.PartialAsync("_MessagePartial", Model, ViewData)
        }
    </div>
</div>

<div class="mt-2 mb-2" id="filePreviewArea" style="display:none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span id="selectedFileName">File đã chọn</span>
            <button type="button" class="btn btn-sm btn-danger" id="removeFile">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body" id="imagePreview" style="display:none; text-align:center;">
            <img id="previewImg" src="" alt="Preview" class="img-fluid" style="max-height: 200px;" />
        </div>
        <div class="card-body" id="fileInfo" style="display:none;">
            <p class="mb-1">Loại file: <span id="fileType"></span></p>
            <p class="mb-1">Kích thước: <span id="fileSize"></span></p>
        </div>
    </div>
</div>

<div class="d-flex mt-2">
    <textarea id="txtMessage" class="form-control" placeholder="Nhập tin nhắn..." disabled></textarea>
</div>
<div class="d-flex mt-2">
    <button id="btnSend" class="btn btn-primary" disabled>Gửi</button>
    <div class="input-group ms-2" style="flex: 1;">
        <input type="file" id="fileInput" class="form-control" disabled />
        <span class="input-group-text text-muted small">Tối đa 25MB</span>
    </div>
</div>