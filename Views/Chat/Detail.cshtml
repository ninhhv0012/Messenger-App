@model List<Messenger_App.Models.MessageDTO>
@{
    var chatId = ViewData["ChatId"];
    var currentUserId = (int)ViewData["CurrentUserId"];
    var currentUsername = ViewData["CurrentUsername"]?.ToString() ?? "Người dùng";
    var chatType = ViewData["ChatType"]?.ToString() ?? "Personal";
    var chatName = ViewData["ChatName"]?.ToString() ?? "Chat";
    ViewData["Title"] = chatName;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">@chatName</h4>
    <span id="connection-status" class="badge bg-success">Đã kết nối</span>
</div>

<input type="hidden" id="chatId" value="@chatId" />
<input type="hidden" id="currentUserId" value="@currentUserId" />
<input type="hidden" id="currentUsername" value="@currentUsername" />
<input type="hidden" id="chatType" value="@chatType" />

<div id="detailContainer" style="height:400px;overflow:auto;">
    <div id="messageList">
        @if (!Model.Any())
        {
            <p class="text-muted">Chưa có tin nhắn</p>
        }
        else
        {
            foreach (var m in Model)
            {
                var align = m.SenderId == currentUserId ? "justify-content-end" : "justify-content-start";
                var bgClass = m.SenderId == currentUserId ? "bg-primary text-white" : "bg-light";

                <div class="d-flex @align mb-2 msg-item" data-timestamp="@m.Timestamp.ToString("o")" data-sender-id="@m.SenderId">
                    <div class="p-2 rounded @bgClass" style="max-width:70%;">
                        @if (chatType == "Group" && m.SenderId != currentUserId)
                        {
                            <div><small><strong>@m.SenderUsername</strong></small></div>
                        }
                        @if (m.MessageType == "Image" && !string.IsNullOrEmpty(m.FilePath))
                        {
                            <img src="@m.FilePath" alt="Image" class="img-fluid" />
                        }
                        else if (m.MessageType == "File" && !string.IsNullOrEmpty(m.FilePath))
                        {
                            <a href="@m.FilePath" download>@System.IO.Path.GetFileName(m.FilePath)</a>
                        }
                        else
                        {
                            <div>@m.Content</div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>
<div class="d-flex mt-2">
    <textarea id="txtMessage" class="form-control" placeholder="Nhập tin nhắn..." disabled></textarea>
</div>
<div class="d-flex mt-2">
    <button id="btnSend" class="btn btn-primary" disabled>Gửi</button>
    <input type="file" id="fileInput" class="form-control ms-2" disabled />
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js" integrity="sha512-7SRCYIJtR6F8ocwW7UxW6wGKqbSyqREDbfCORCbGLatU0iugBLwyOXpzhkPyHIFdBO0K2VCu57fvP2Twgx1o2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script src="~/js/chat.js"></script>
}